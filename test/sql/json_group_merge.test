# name: test/sql/json_group_merge.test
# description: json_group_merge merges ordered JSON patches with RFC 7396 semantics
# group: [sql]

require json_tools

# Ensure helper constructors from the json extension are available
require json

# ========================================
# Basic Merge Semantics
# ========================================

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES ('{"a":1}'::json, 1), ('{"b":2}'::json, 2)) AS t(patch, ts);
----
{"a":1,"b":2}

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES ('{"obj":{"x":1}}'::json, 1), ('{"obj":{"y":2}}'::json, 2)) AS t(patch, ts);
----
{"obj":{"x":1,"y":2}}

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES ('{"arr":[1,2]}'::json, 1), ('{"arr":[3]}'::json, 2)) AS t(patch, ts);
----
{"arr":[3]}

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES ('{"flag":true}'::json, 1), ('{"flag":false}'::json, 2)) AS t(patch, ts);
----
{"flag":false}

# ========================================
# NULL Handling
# ========================================

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES (NULL::json, 1), ('{"keep":1}'::json, 2)) AS t(patch, ts);
----
{"keep":1}

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES (NULL::json, 1)) AS t(patch, ts);
----
{}

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES ('{"keep":1}'::json, 1), ('{"keep":null}'::json, 2)) AS t(patch, ts);
----
{}

# ========================================
# treat_null_values Parameter
# ========================================

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES ('{"keep":1}'::json, 1), ('{"keep":null}'::json, 2)) AS t(patch, ts);
----
{"keep":1}

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES ('{"keep":1,"drop":null}'::json, 1)) AS t(patch, ts);
----
{"keep":1}

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES ('{"outer":{"drop":null}}'::json, 1)) AS t(patch, ts);
----
{}

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES
    ('{"outer":{"drop":10,"keep":5}}'::json, 1),
    ('{"outer":{"drop":null,"keep":7}}'::json, 2)
) AS t(patch, ts);
----
{"outer":{"drop":10,"keep":7}}

query I
SELECT json_group_merge(patch, '  delete nulls  ' ORDER BY ts)
FROM (VALUES ('{"keep":1}'::json, 1), ('{"keep":null}'::json, 2)) AS t(patch, ts);
----
{}

statement error
SELECT json_group_merge(patch, 'DROP' ORDER BY ts)
FROM (VALUES ('{"keep":1}'::json, 1)) AS t(patch, ts);
----
Invalid Input Error: json_group_merge: treat_null_values must be one of DELETE NULLS, IGNORE NULLS

statement error
SELECT json_group_merge(patch, NULL ORDER BY ts)
FROM (VALUES ('{"keep":1}'::json, 1)) AS t(patch, ts);
----
Invalid Input Error: json_group_merge: treat_null_values must be one of DELETE NULLS, IGNORE NULLS

statement error
SELECT json_group_merge(patch, mode ORDER BY patch)
FROM (VALUES ('{"keep":1}'::json, 'IGNORE NULLS')) AS t(patch, mode);
----
Binder Error: json_group_merge treat_null_values argument must be constant

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES ('{"a":1}', 1), ('{"a":null}', 2)) AS t(patch, ts);
----
{"a":1}

query II
SELECT grp, json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES ('A', 1, '{"x":1}'::json), ('A', 2, '{"x":null}'::json)) AS t(grp, ts, patch)
GROUP BY grp;
----
A	{"x":1}

# Edge cases for IGNORE NULLS

query I
SELECT json_group_merge('{}', 'IGNORE NULLS');
----
{}

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES ('{"a":null}'::json, 1), ('{"b":null}'::json, 2)) AS t(patch, ts);
----
{}

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES
    ('{"a":{"b":{"c":{"d":1}}}}'::json, 1),
    ('{"a":{"b":{"c":null}}}'::json, 2)
) AS t(patch, ts);
----
{"a":{"b":{"c":{"d":1}}}}

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES
    ('{"a":{"b":{"c":1}}}'::json, 1),
    ('{"a":{"b":null}}'::json, 2)
) AS t(patch, ts);
----
{"a":{"b":{"c":1}}}

# ========================================
# VARCHAR Input Support
# ========================================

query I
SELECT json_group_merge(payload ORDER BY ts)
FROM (VALUES ('{"source":"varchar"}', 1)) AS t(payload, ts);
----
{"source":"varchar"}

# ========================================
# Ordering Behaviour
# ========================================

query I
SELECT json_group_merge(patch ORDER BY ts ASC)
FROM (VALUES ('{"value":"first"}'::json, 1), ('{"value":"second"}'::json, 2)) AS t(patch, ts);
----
{"value":"second"}

query I
SELECT json_group_merge(patch ORDER BY ts DESC)
FROM (VALUES ('{"value":"first"}'::json, 1), ('{"value":"second"}'::json, 2)) AS t(patch, ts);
----
{"value":"first"}

query I
SELECT json_group_merge(patch ORDER BY -ts)
FROM (VALUES ('{"v":1}'::json, 1), ('{"v":2}'::json, 2), ('{"v":3}'::json, 3)) AS t(patch, ts);
----
{"v":1}

# ========================================
# Grouped Aggregation
# ========================================

query II
SELECT session_id, json_group_merge(patch ORDER BY ts)
FROM (VALUES
    ('alpha', 1, '{"state":{"stage":1}}'::json),
    ('alpha', 2, '{"state":{"stage":2}}'::json),
    ('beta', 1, '{"state":{"mode":"dark"}}'::json),
    ('beta', 3, '{"state":{"mode":"light"}}'::json)
) AS t(session_id, ts, patch)
GROUP BY session_id
ORDER BY session_id;
----
alpha	{"state":{"stage":2}}
beta	{"state":{"mode":"light"}}

# ========================================
# Window Aggregation
# ========================================

query IT
SELECT seq,
       json_group_merge(patch ORDER BY seq)
           OVER (PARTITION BY grp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
FROM (VALUES
    (1, 'A', '{"score":1}'::json),
    (2, 'A', '{"score":2}'::json),
    (3, 'A', '{"bonus":true}'::json),
    (1, 'B', '{"score":5}'::json),
    (2, 'B', '{"score":7}'::json)
) AS t(seq, grp, patch)
ORDER BY grp, seq;
----
1	{"score":1}
2	{"score":2}
3	{"score":2,"bonus":true}
1	{"score":5}
2	{"score":7}

# ========================================
# Nested Merge, Removal, and Replacement
# ========================================

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES
    ('{"settings":{"theme":"light","options":{"font":"sans","color":"blue"}}}'::json, 1),
    ('{"settings":{"options":{"color":"red"},"extra":true}}'::json, 2),
    ('{"settings":{"options":{"font":null}}}'::json, 3)
) AS t(patch, ts);
----
{"settings":{"theme":"light","options":{"color":"red"},"extra":true}}

query I
SELECT json_group_merge(patch ORDER BY ts)
FROM (VALUES
    ('{"result":{"status":"pending"}}'::json, 1),
    ('"complete"'::json, 2)
) AS t(patch, ts);
----
"complete"

# ========================================
# Error Handling
# ========================================

statement error
SELECT json_group_merge('{');
----
Invalid Input Error: json_group_merge: Malformed JSON at byte 1 of input: unexpected end of data.  Input: "{"

# ========================================
# Combine Correctness (Parallel Aggregation)
# ========================================

statement ok
PRAGMA threads=4;

statement ok
PRAGMA verify_parallelism;

query III
WITH patches AS (
    SELECT
        g AS grp,
        ts,
        CASE
            WHEN ts = 0 THEN '{"a":1}'::JSON
            WHEN ts = 9999 THEN '{"a":null}'::JSON
            ELSE '{}'::JSON
        END AS patch
    FROM range(0, 8) g(g)
    CROSS JOIN range(0, 10000) t(ts)
)
SELECT
    grp,
    json_group_merge(patch ORDER BY ts) AS agg,
    list_reduce(list(patch ORDER BY ts), (acc, p) -> json_merge_patch(acc, p), '{}'::JSON) AS baseline
FROM patches
GROUP BY grp
ORDER BY grp;
----
0	{}	{}
1	{}	{}
2	{}	{}
3	{}	{}
4	{}	{}
5	{}	{}
6	{}	{}
7	{}	{}

query II
WITH patches AS (
    SELECT
        g AS grp,
        ts,
        CASE
            WHEN ts = 0 THEN '{"a":1}'::JSON
            WHEN ts = 9999 THEN '{"a":null}'::JSON
            ELSE '{}'::JSON
        END AS patch
    FROM range(0, 8) g(g)
    CROSS JOIN range(0, 10000) t(ts)
)
SELECT
    grp,
    json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts) AS agg
FROM patches
GROUP BY grp
ORDER BY grp;
----
0	{"a":1}
1	{"a":1}
2	{"a":1}
3	{"a":1}
4	{"a":1}
5	{"a":1}
6	{"a":1}
7	{"a":1}

# ========================================
# Serialization Bug Regression
# ========================================

# Verify that 'IGNORE NULLS' is preserved after serialization/deserialization.
# If the argument is erased during bind, re-bind might default to 'DELETE NULLS'.

statement ok
PRAGMA verify_serializer;

query I
SELECT json_group_merge(patch, 'IGNORE NULLS' ORDER BY ts)
FROM (VALUES ('{"a":1}'::json, 1), ('{"a":null}'::json, 2)) AS t(patch, ts);
----
{"a":1}
