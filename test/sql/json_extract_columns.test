# name: test/sql/json_extract_columns.test
# description: json_extract_columns extracts regex-selected root keys into a struct of VARCHAR fields
# group: [sql]

require json_tools

# Ensure helper constructors from the json extension are available
require json

# Basic extraction
query I
SELECT (json_extract_columns('{"id": 5, "name": "duck"}', '{"id": "^id$", "name": "^name$"}', ',')).id;
----
5

query I
SELECT (json_extract_columns('{"id": 5, "name": "duck"}', '{"id": "^id$", "name": "^name$"}', ',')).name;
----
duck

# Multiple matches and separators
query I
SELECT (json_extract_columns('{"a":1,"a2":2,"b":3}', '{"a":"^a","b":"^b$"}', '|')).a;
----
1|2

query I
SELECT (json_extract_columns('{"x":"a","xx":"b"}', '{"col":"x"}', '')).col;
----
ab

query I
SELECT (json_extract_columns('{"x":"a","xx":"b"}', '{"col":"x"}')).col;
----
ab

query I
SELECT (json_extract_columns('{"abc":1,"xabcx":2}', '{"v":"abc"}', ',')).v;
----
1,2

# No matches return NULL
query I
SELECT (json_extract_columns('{"a":1}', '{"missing":"z"}', ',')).missing IS NULL;
----
true

# Mixed value types stringify
query I
WITH res AS (
    SELECT json_extract_columns('{"arr":[1,2],"obj":{"k":1},"flag":true,"none":null}',
                                '{"arr":"arr","obj":"obj","flag":"flag","none":"none"}', ',') AS r)
SELECT r.arr = '[1,2]' AND r.obj = '{"k":1}' AND r.flag = 'true' AND r.none = 'null' AS ok
FROM res;
----
true

# Deterministic ordering and case sensitivity controls
query I
WITH cte AS (
    SELECT json_extract_columns('{"b":1,"a":2,"ab":3}', '{"v":"a"}', '|') AS r1,
           json_extract_columns('{"b":1,"a":2,"ab":3}', '{"v":"a"}', '|') AS r2)
SELECT r1.v = r2.v AS stable
FROM cte;
----
true

query I
SELECT (json_extract_columns('{"Key": "Value"}', '{"k":"(?i)^key$"}', ',')).k;
----
Value

query I
SELECT (json_extract_columns('{"Key": "Value"}', '{"k":"^key$"}', ',')).k IS NULL;
----
true

# Separator NULL errors
statement error
SELECT json_extract_columns('{"a":1}', '{"a":"a"}', NULL);
----
Invalid Input Error: json_extract_columns: separator cannot be NULL

statement error
SELECT json_extract_columns(NULL, '{"a":"a"}', NULL);
----
Invalid Input Error: json_extract_columns: separator cannot be NULL

# Input shape errors
statement error
SELECT json_extract_columns('[1,2]', '{"a":"a"}', ',');
----
Invalid Input Error: json_extract_columns: expected JSON object input

statement error
SELECT json_extract_columns('{"a":1}', '["a"]', ',');
----
Binder Error: json_extract_columns: columns argument must be a JSON object

statement error
SELECT json_extract_columns('{"a":1}', '{"a": 1}', ',');
----
Binder Error: json_extract_columns: column patterns must be strings

statement error
SELECT json_extract_columns('{"a":1}', '{"a":".*", "a":"again"}', ',');
----
Binder Error: json_extract_columns: duplicate output column name "a"

statement error
SELECT json_extract_columns('{"a":1}', '{"a":"["}', ',');
----
<REGEX>:.*json_extract_columns: missing ].*

statement error
SELECT to_json(json_extract_columns('{"a":1}', '{}', ','));
----
Binder Error: json_extract_columns: column patterns must not be empty

# Test with >64 columns (fallback path without bitset cache)
# Uses 70 columns to exceed the 64-column bitset limit
query I
SELECT (json_extract_columns(
    '{"k0":0,"k1":1,"k2":2,"k3":3,"k4":4,"k5":5,"k6":6,"k7":7,"k8":8,"k9":9,"k10":10,"k11":11,"k12":12,"k13":13,"k14":14,"k15":15,"k16":16,"k17":17,"k18":18,"k19":19,"k20":20,"k21":21,"k22":22,"k23":23,"k24":24,"k25":25,"k26":26,"k27":27,"k28":28,"k29":29,"k30":30,"k31":31,"k32":32,"k33":33,"k34":34,"k35":35,"k36":36,"k37":37,"k38":38,"k39":39,"k40":40,"k41":41,"k42":42,"k43":43,"k44":44,"k45":45,"k46":46,"k47":47,"k48":48,"k49":49,"k50":50,"k51":51,"k52":52,"k53":53,"k54":54,"k55":55,"k56":56,"k57":57,"k58":58,"k59":59,"k60":60,"k61":61,"k62":62,"k63":63,"k64":64,"k65":65,"k66":66,"k67":67,"k68":68,"k69":69}',
    '{"c0":"^k0$","c1":"^k1$","c2":"^k2$","c3":"^k3$","c4":"^k4$","c5":"^k5$","c6":"^k6$","c7":"^k7$","c8":"^k8$","c9":"^k9$","c10":"^k10$","c11":"^k11$","c12":"^k12$","c13":"^k13$","c14":"^k14$","c15":"^k15$","c16":"^k16$","c17":"^k17$","c18":"^k18$","c19":"^k19$","c20":"^k20$","c21":"^k21$","c22":"^k22$","c23":"^k23$","c24":"^k24$","c25":"^k25$","c26":"^k26$","c27":"^k27$","c28":"^k28$","c29":"^k29$","c30":"^k30$","c31":"^k31$","c32":"^k32$","c33":"^k33$","c34":"^k34$","c35":"^k35$","c36":"^k36$","c37":"^k37$","c38":"^k38$","c39":"^k39$","c40":"^k40$","c41":"^k41$","c42":"^k42$","c43":"^k43$","c44":"^k44$","c45":"^k45$","c46":"^k46$","c47":"^k47$","c48":"^k48$","c49":"^k49$","c50":"^k50$","c51":"^k51$","c52":"^k52$","c53":"^k53$","c54":"^k54$","c55":"^k55$","c56":"^k56$","c57":"^k57$","c58":"^k58$","c59":"^k59$","c60":"^k60$","c61":"^k61$","c62":"^k62$","c63":"^k63$","c64":"^k64$","c65":"^k65$","c66":"^k66$","c67":"^k67$","c68":"^k68$","c69":"^k69$"}',
    ','
)).c0 = '0' AND (json_extract_columns(
    '{"k0":0,"k1":1,"k2":2,"k3":3,"k4":4,"k5":5,"k6":6,"k7":7,"k8":8,"k9":9,"k10":10,"k11":11,"k12":12,"k13":13,"k14":14,"k15":15,"k16":16,"k17":17,"k18":18,"k19":19,"k20":20,"k21":21,"k22":22,"k23":23,"k24":24,"k25":25,"k26":26,"k27":27,"k28":28,"k29":29,"k30":30,"k31":31,"k32":32,"k33":33,"k34":34,"k35":35,"k36":36,"k37":37,"k38":38,"k39":39,"k40":40,"k41":41,"k42":42,"k43":43,"k44":44,"k45":45,"k46":46,"k47":47,"k48":48,"k49":49,"k50":50,"k51":51,"k52":52,"k53":53,"k54":54,"k55":55,"k56":56,"k57":57,"k58":58,"k59":59,"k60":60,"k61":61,"k62":62,"k63":63,"k64":64,"k65":65,"k66":66,"k67":67,"k68":68,"k69":69}',
    '{"c0":"^k0$","c1":"^k1$","c2":"^k2$","c3":"^k3$","c4":"^k4$","c5":"^k5$","c6":"^k6$","c7":"^k7$","c8":"^k8$","c9":"^k9$","c10":"^k10$","c11":"^k11$","c12":"^k12$","c13":"^k13$","c14":"^k14$","c15":"^k15$","c16":"^k16$","c17":"^k17$","c18":"^k18$","c19":"^k19$","c20":"^k20$","c21":"^k21$","c22":"^k22$","c23":"^k23$","c24":"^k24$","c25":"^k25$","c26":"^k26$","c27":"^k27$","c28":"^k28$","c29":"^k29$","c30":"^k30$","c31":"^k31$","c32":"^k32$","c33":"^k33$","c34":"^k34$","c35":"^k35$","c36":"^k36$","c37":"^k37$","c38":"^k38$","c39":"^k39$","c40":"^k40$","c41":"^k41$","c42":"^k42$","c43":"^k43$","c44":"^k44$","c45":"^k45$","c46":"^k46$","c47":"^k47$","c48":"^k48$","c49":"^k49$","c50":"^k50$","c51":"^k51$","c52":"^k52$","c53":"^k53$","c54":"^k54$","c55":"^k55$","c56":"^k56$","c57":"^k57$","c58":"^k58$","c59":"^k59$","c60":"^k60$","c61":"^k61$","c62":"^k62$","c63":"^k63$","c64":"^k64$","c65":"^k65$","c66":"^k66$","c67":"^k67$","c68":"^k68$","c69":"^k69$"}',
    ','
)).c69 = '69' AS ok;
----
true
